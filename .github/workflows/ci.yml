# GitHub Actions CI Workflow for ThesisTrack
# Runs PHPUnit tests on push/PR - handles PHP >= 8.2 compatibility

name: ThesisTrack CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  login_tests:
    name: Login Tests PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.2', '8.3']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: pdo, pdo_mysql, mbstring, xml, curl, gd, zip
          coverage: xdebug
          tools: composer:v2
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
      - name: Run Login PHPUnit Tests
        run: vendor/bin/phpunit tests/LoginTest.php --testdox --colors=always
        env:
          DB_HOST: 127.0.0.1
          DB_NAME: thesis_track
          DB_USER: root
          DB_PASS: ""

  registration_tests:
    name: Registration Tests PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.2', '8.3']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: pdo, pdo_mysql, mbstring, xml, curl, gd, zip
          coverage: xdebug
          tools: composer:v2
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
      - name: Run Registration PHPUnit Tests
        run: vendor/bin/phpunit tests/RegistrationTest.php --testdox --colors=always
        env:
          DB_HOST: 127.0.0.1
          DB_NAME: thesis_track
          DB_USER: root
          DB_PASS: ""

  file_upload_tests:
    name: File Upload Tests PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.2', '8.3']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: pdo, pdo_mysql, mbstring, xml, curl, gd, zip
          coverage: xdebug
          tools: composer:v2
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
      - name: Run File Upload PHPUnit Tests
        run: vendor/bin/phpunit tests/FileUploadTest.php --testdox --colors=always
        env:
          DB_HOST: 127.0.0.1
          DB_NAME: thesis_track
          DB_USER: root
          DB_PASS: ""

  session_auth_tests:
    name: Session/Auth Tests PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.2', '8.3']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: pdo, pdo_mysql, mbstring, xml, curl, gd, zip
          coverage: xdebug
          tools: composer:v2
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
      - name: Run Session/Auth PHPUnit Tests
        run: vendor/bin/phpunit tests/SessionManagementTest.php tests/AuthTest.php --testdox --colors=always
        env:
          DB_HOST: 127.0.0.1
          DB_NAME: thesis_track
          DB_USER: root
          DB_PASS: ""

  utility_tests:
    name: Utility Functions Tests PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.2', '8.3']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: pdo, pdo_mysql, mbstring, xml, curl, gd, zip
          coverage: xdebug
          tools: composer:v2
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
      - name: Run Utility Functions PHPUnit Tests
        run: vendor/bin/phpunit tests/UtilityFunctionsTest.php --testdox --colors=always
        env:
          DB_HOST: 127.0.0.1
          DB_NAME: thesis_track
          DB_USER: root
          DB_PASS: ""

  lint:
    name: PHP Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
      - name: Run PHP syntax check
        run: |
          find . -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -n1 php -l
